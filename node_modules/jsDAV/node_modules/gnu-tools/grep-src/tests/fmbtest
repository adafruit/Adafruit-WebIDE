#! /bin/sh
# Copyright (C) 2001, 2006, 2009-2012 Free Software Foundation, Inc.
#
# Copying and distribution of this file, with or without modification,
# are permitted in any medium without royalty provided the copyright
# notice and this notice are preserved.

. "${srcdir=.}/init.sh"; path_prepend_ ../src

cz=cs_CZ.UTF-8

# If cs_CZ.UTF-8 locale doesn't work, skip this test.
LC_ALL=$cz locale -k LC_CTYPE 2>/dev/null | grep -q charmap.*UTF-8 \
  || skip_ this system lacks the $cz locale

# If matching is done in single-byte mode, skip this test too
printf '칠\n' | LC_ALL=$cz grep -Eq '^[칠]{2}$'
case $? in
  0) skip_ "built without multi-byte support";;
  1) ;;
  *) fail_ "unexpected exit status: $?";;
esac

failures=0

cat > csinput <<EOF
01 콯lu콘ou캜k치 캜칤코e
캛칤E 02
03 Z 캜칤코칤 캛i코칤 cosi
04 캛칤
만 05
06 캛캛캛캛캛캛캛칤코캛칈먟꽊솬
07 캛캛캛 캛캛캛캛칤코캛칈먟꽊솬멘EEE
캜As 08
09캛apka
10캛aSy se m캩n칈
캛칈코E11
캛as12
洧돣꺢꽌멘洧13
콯캛칈코E洧14
洧돣꺢꽌멘콯15
콯캛칈코E콯16
캛칈코E洧17
캛칈코E콯18
19洧돣꺢꽌면
20콯캛칈코e
EOF
cat > cspatfile <<EOF
캛칈코E
캛as
EOF

for mode in F G E; do

test1="$(echo $(LC_ALL=$cz grep -${mode} -f cspatfile csinput \
               | LC_ALL=C sed 's/^.*\([0-9][0-9]\).*$/\1/'))"
if test "$test1" != "11 12 13 14 15 16 17 18"; then
  echo "Test #1 ${mode} failed: $test1"
  failures=1
fi

test2="$(echo $(LC_ALL=$cz grep -${mode}i -f cspatfile csinput \
               | LC_ALL=C sed 's/^.*\([0-9][0-9]\).*$/\1/'))"
if test "$test2" != "01 02 07 08 10 11 12 13 14 15 16 17 18 19 20"; then
  echo "Test #2 ${mode} failed: $test2"
  failures=1
fi

test3="$(echo $(LC_ALL=$cz grep -${mode}i -e '캛칈코E' -e '캛as' csinput \
               | LC_ALL=C sed 's/^.*\([0-9][0-9]\).*$/\1/'))"
if test "$test3" != "01 02 07 08 10 11 12 13 14 15 16 17 18 19 20"; then
  echo "Test #3 ${mode} failed: $test3"
  failures=1
fi

# Skip the next test - known to fail. TAA.
#test4="$(echo $(LC_ALL=$cz grep -${mode}iw -f cspatfile csinput \
#	       | LC_ALL=C sed 's/^.*\([0-9][0-9]\).*$/\1/'))"
#if test "$test4" != "01 02 08 13 17 19"; then
#  echo "Test #4 ${mode} failed: $test4"
#  failures=1
#fi

# Test that --color=always does not depend on individual pattern order within the pattern
# list, and that a longer match is preferred to a shorter one starting at the same point.
test6="$(echo 'Cosi tu 캛i코칈...' \
        | LC_ALL=$cz grep --color=always -${mode}i -e '캜i코' -e '캜i코칤')"
if echo "$test6" | LC_ALL=C grep -q 'Cosi tu .*\[.*m\(.\[K\)\?캛i코칈.*\[.*m\(.\[K\)\?\.\.\.'; then
  :
else
  echo "Test #6 ${mode} failed: $test6"
  failures=1
fi

# Test that --color=always does not depend on individual pattern order within the pattern
# list, and that a longer match is preferred to a shorter one starting at the same point.
test7="$(echo 'Cosi tu 캛i코칈...' \
        | LC_ALL=$cz grep --color=always -${mode}i -e '캜i코칤' -e '캜i코')"
if echo "$test7" | LC_ALL=C grep -q 'Cosi tu .*\[.*m\(.\[K\)\?캛i코칈.*\[.*m\(.\[K\)\?\.\.\.'; then
  :
else
  echo "Test #7 ${mode} failed: $test7"
  failures=1
fi

done

for mode in G E; do

test8="$(echo $(LC_ALL=$cz grep -${mode}i -e '캛.코E' -e '캛[a-f]s' csinput \
               | LC_ALL=C sed 's/^.*\([0-9][0-9]\).*$/\1/'))"
if test "$test8" != "01 02 07 08 10 11 12 13 14 15 16 17 18 19 20"; then
  echo "Test #8 ${mode} failed: $test8"
  failures=1
fi

done

Exit $failures
